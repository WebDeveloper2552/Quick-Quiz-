
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Genius AI Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    :root {
        --primary-blue: #4361ee;
        --dark-blue: #3a0ca3;
        --white: #ffffff;
        --light-gray: #f8f9fa;
        --medium-gray: #e9ecef;
        --dark-gray: #6c757d;
        --text-dark: #212529;
        --text-light: #f5f7fa;
        --success: #4cc9f0;
        --warning: #f72585;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.15);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.2);
        --border-radius-sm: 8px;
        --border-radius-md: 12px;
        --border-radius-lg: 16px;
        --transition: all 0.3s ease;
        
        /* Purple shades */
        --purple-1: #9c27b0;
        --purple-2: #8e24aa;
        --purple-3: #7b1fa2;
        --purple-4: #6a1b9a;
        --purple-5: #5e35b1;
        --purple-6: #512da8;
        --purple-7: #4527a0;
        --purple-8: #311b92;
        --purple-9: #4a148c;
        --purple-10: #7e57c2;
        --purple-11: #673ab7;
        --purple-12: #5e35b1;
        --purple-13: #d500f9;
        --purple-14: #aa00ff;
        --purple-15: #b388ff;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background:url('ai_chatbot_background.png');
        color: var(--text-dark);
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    /* ===== NAVBAR ===== */
    .navbar-custom {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--purple-7) 100%) !important;
        box-shadow: var(--shadow-sm);
        padding: 0.75rem 1.5rem;
    }

    .navbar-brand {
        color: var(--white) !important;
        font-weight: 700;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .navbar-brand img {
        height: 32px;
        width: 32px;
        object-fit: contain;
    }

    .nav-link {
        color: var(--white) !important;
        font-weight: 500;
        padding: 0.5rem 1rem !important;
        transition: var(--transition);
        border-radius: var(--border-radius-sm);
    }

    .nav-link:hover, 
    .nav-link.active {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
    }

    .dropdown-menu {
        border-radius: var(--border-radius-sm) !important;
        border: none !important;
        box-shadow: var(--shadow-md);
        padding: 0.5rem 0;
    }

    .dropdown-item {
        padding: 0.5rem 1.25rem;
        transition: var(--transition);
    }

    .dropdown-item:hover {
        background-color: var(--light-gray);
        color: var(--primary-blue);
    }

    /* ===== MAIN CONTAINER ===== */
    .ai-container {
        background: var(--white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        max-width: 1400px;
        width: 95%;
        margin: 2rem auto;
        overflow: hidden;
        flex: 1;
    }

    /* ===== HEADER ===== */
    .ai-header {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
        color: var(--white);
        padding: 1.25rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .ai-title {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-weight: 600;
        font-size: 1.4rem;
    }

    .ai-icon {
        width: 40px;
        height: 40px;
        background-image: url('https://clipart-library.com/new_gallery/406-4068418_testimonial-coming-soon-graduation-hat-silhouette-png.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }

    .badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 100px;
        font-size: 0.8rem;
        font-weight: 600;
        background-color: var(--success);
        color: var(--white);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: var(--shadow-sm);
    }

     /* ===== ROUTE SELECTOR ===== */
    .route-selector {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .route-label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.9);
    }

    .route-dropdown {
        position: relative;
    }

    .route-btn {
        background: rgba(255, 255, 255, 0.15);
        border: none;
        color: var(--white);
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius-sm);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition);
    }

    .route-btn:hover {
        background: rgba(255, 255, 255, 0.25);
    }

    .route-btn::after {
        content: '‚ñº';
        font-size: 0.6rem;
        margin-left: 0.5rem;
    }

    .route-options {
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--white);
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow-md);
        padding: 0.5rem 0;
        min-width: 200px;
        z-index: 100;
        display: none;
    }

    .route-options.show {
        display: block;
        animation: fadeIn 0.2s ease;
    }

    .route-option {
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--text-dark) !important;
    }

    .route-option:hover {
        background: var(--light-gray);
    }

        
        .route-digital::before { background: var(--digital-color); }
        .route-business::before { background: var(--business-color); }
        .route-health::before { background: var(--health-color); }
        .route-engineering::before { background: var(--engineering-color); }
        .route-science::before { background: var(--science-color); }
        .route-education::before { background: var(--education-color); }
        .route-accounting::before { background: var(--accounting-color); }
        .route-law::before { background: var(--law-color); }
        
        /* Main Content Area */
        .ai-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Sidebar */
        .ai-sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
            transition: var(--transition);
        }
        
        .sidebar-section {
            margin-bottom: 25px;
        }
        
        .sidebar-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 15px;
            letter-spacing: 1px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-title .badge {
            margin-left: 0;
            font-size: 0.7rem;
            padding: 3px 8px;
        }
        
        .topic-list {
            list-style: none;
        }
        
        .topic-item {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            font-size: 0.95rem;
        }
        
        .topic-item:hover {
            background-color: #f1f3f9;
        }
        
        .topic-item.active {
            background-color: var(--purple-5);
            color: white;
            font-weight: 500;
        }
        
        .topic-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            opacity: 0.7;
        }
        
        .topic-item.active .topic-icon {
            opacity: 1;
            filter: brightness(0) invert(1);
        }
        
        /* Main Chat Area */
        .ai-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Tabs */
        .ai-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 0 20px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .ai-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .tab-btn {
            padding: 15px 25px;
            border: none;
            background: none;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            font-size: 0.95rem;
            white-space: nowrap;
        }
        
        .tab-btn:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--purple-5);
            transition: var(--transition);
        }
        
        .tab-btn:hover {
            color: var(--purple-5);
        }
        
        .tab-btn.active {
            color: var(--purple-5);
            font-weight: 600;
        }
        
        .tab-btn.active:after {
            width: 100%;
        }
        
        /* Tab Content */
        .tab-content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
            font-size: 0.95rem;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 5px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
            font-family: 'Poppins', sans-serif;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            border-color: var(--purple-5);
            outline: none;
            box-shadow: 0 0 0 3px rgba(123, 31, 162, 0.2);
        }
        
        /* Buttons - 3D Effect */
        .btn {
            position: relative;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.95rem;
            margin-right: 10px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            transform: translateY(0);
        }
        
        /* Purple buttons with different shades */
        .btn-purple-1 { background-color: var(--purple-1); }
        .btn-purple-2 { background-color: var(--purple-2); }
        .btn-purple-3 { background-color: var(--purple-3); }
        .btn-purple-4 { background-color: var(--purple-4); }
        .btn-purple-5 { background-color: var(--purple-5); }
        .btn-purple-6 { background-color: var(--purple-6); }
        .btn-purple-7 { background-color: var(--purple-7); }
        .btn-purple-8 { background-color: var(--purple-8); }
        .btn-purple-9 { background-color: var(--purple-9); }
        .btn-purple-10 { background-color: var(--purple-10); }
        .btn-purple-11 { background-color: var(--purple-11); }
        .btn-purple-12 { background-color: var(--purple-12); }
        .btn-purple-13 { background-color: var(--purple-13); }
        .btn-purple-14 { background-color: var(--purple-14); }
        .btn-purple-15 { background-color: var(--purple-15); }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background-color: #e9ecef;
            color: #495057;
            box-shadow: 0 4px 0 #adb5bd;
        }
        
        .btn-secondary:hover {
            background-color: #dee2e6;
            box-shadow: 0 6px 0 #adb5bd;
        }
        
        .btn-secondary:active {
            box-shadow: 0 2px 0 #adb5bd;
        }
        
        .btn-warning {
            background-color: var(--warning);
            box-shadow: 0 4px 0 #b5174e;
        }
        
        .btn-warning:hover {
            background-color: #e5177e;
            box-shadow: 0 6px 0 #b5174e;
        }
        
        .btn-warning:active {
            box-shadow: 0 2px 0 #b5174e;
        }
        
        /* LaTeX Toolbar */
        .latex-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }
        
        .latex-btn {
            position: relative;
            background-color: var(--purple-10);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
            transform: translateY(0);
        }
        
        .latex-btn:hover {
            background-color: var(--purple-11);
            transform: translateY(-2px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        
        .latex-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.2);
        }
        
        /* Preview Areas */
        .preview-box {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px dashed #ced4da;
        }
        
        .preview-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--purple-5);
            font-weight: 600;
        }
        
        /* Question List */
        .question-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 10px;
        }
        
        .question-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: white;
            border: 1px solid #e9ecef;
            transition: var(--transition);
        }
        
        .question-item:hover {
            border-color: var(--purple-5);
            box-shadow: var(--shadow);
        }
        
        .question-item.selected {
            background-color: #edf2fb;
            border-color: var(--purple-5);
        }
        
        .question-checkbox {
            margin-right: 10px;
        }
        
        /* Processing State */
        .processing {
            display: none;
            text-align: center;
            padding: 30px;
            background-color: #f8f9fa;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .processing .spinner {
            border: 4px solid rgba(67, 97, 238, 0.1);
            border-top: 4px solid var(--purple-5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Response Area */
        .response-area {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e9ecef;
            display: none;
        }
        
        .response-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--purple-5);
            font-weight: 600;
        }
        
        /* Topic Tags */
        .topic-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 8px;
            margin-bottom: 8px;
            background-color: #e9ecef;
            color: #495057;
        }
        
        .topic-tag.algebra {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .topic-tag.geometry {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .topic-tag.calculus {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        
        .topic-tag.statistics {
            background-color: #fff3e0;
            color: #e65100;
        }
        
        /* Action Buttons Container */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* Repository Connection */
        .repository-connection {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-connected {
            background-color: #4caf50;
        }
        
        .status-disconnected {
            background-color: #f44336;
        }
        
        /* Quiz builder panel */
        .quiz-builder-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e9ecef;
            box-shadow: var(--shadow);
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .quiz-builder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .quiz-builder-title {
            font-weight: 600;
            color: var(--purple-5);
        }
        
        .quiz-count {
            background: var(--purple-5);
            color: white;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .quiz-questions-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
        }
        
        .quiz-question-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .quiz-question-item:last-child {
            border-bottom: none;
        }
        
        .remove-question-btn {
            background: none;
            border: none;
            color: #f72585;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 5px;
        }
        
        /* Responsive Design */
        @media (max-width: 992px) {
            .ai-container {
                height: auto;
                min-height: 90vh;
            }
            
            .ai-content {
                flex-direction: column;
            }
            
            .ai-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                max-height: 200px;
            }
            
            .ai-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .tab-btn {
                padding: 15px 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .ai-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .route-selector {
                margin-left: 0;
                margin-top: 10px;
            }
        }

        /* Footer */
        .ai-footer {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: #fff;
            padding: 30px 0 15px 0;
            margin-top: 40px;
            box-shadow: 0 -2px 16px rgba(67, 97, 238, 0.08);
            font-family: 'Poppins', sans-serif;
            width: 100%;
        }
        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .footer-brand {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
        }
        .footer-logo {
            width: 38px;
            height: 38px;
            margin-right: 12px;
            border-radius: 8px;
            background: #fff;
            object-fit: contain;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.10);
        }
        .footer-title {
            font-size: 1.3rem;
            font-weight: 600;
            letter-spacing: 1px;
        }
        .footer-links {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            margin-bottom: 14px;
        }
        .footer-links a {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
            opacity: 0.92;
        }
        .footer-links a:hover {
            color: #f72585;
            text-decoration: underline;
            opacity: 1;
        }
        .footer-copy {
            font-size: 0.95rem;
            opacity: 0.8;
            margin-top: 6px;
            text-align: center;
        }
        @media (max-width: 700px) {
            .footer-container {
                padding: 0 10px;
            }
            .footer-links {
                gap: 10px;
                font-size: 0.95rem;
            }
            .footer-title {
                font-size: 1.05rem;
            }
        }

        /* Enhanced Math Keyboard Modal */
        .math-keyboard-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0; 
            top: 0; 
            width: 100vw; 
            height: 100vh;
            background: rgba(0,0,0,0.15);
            align-items: flex-end;
            justify-content: center;
        }
        
        .math-keyboard-content {
            background: #fff;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -2px 16px rgba(67,97,238,0.13);
            padding: 18px 12px 10px 12px;
            width: 100%;
            max-width: 800px;
            margin-bottom: 0;
            animation: fadeInUp 0.2s;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .math-keyboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }
        
        .math-keyboard-title {
            font-weight: 600;
            color: var(--purple-5);
            font-size: 1.1rem;
        }
        
        .math-keyboard-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #888;
            cursor: pointer;
            padding: 5px;
        }
        
        .math-keyboard-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 15px;
        }
        
        .math-keyboard-tab {
            padding: 10px 15px;
            border: none;
            background: none;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            position: relative;
        }
        
        .math-keyboard-tab.active {
            color: var(--purple-5);
            font-weight: 600;
        }
        
        .math-keyboard-tab.active:after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--purple-5);
        }
        
        .math-keyboard-panel {
            display: none;
            padding: 5px;
        }
        
        .math-keyboard-panel.active {
            display: block;
        }
        
        .math-keyboard-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
            justify-content: center;
        }
        
        .math-key-btn {
            min-width: 50px;
            height: 50px;
            padding: 10px;
            border: none;
            background: var(--purple-10);
            color: white;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }
        
        .math-key-btn:hover {
            background: var(--purple-11);
            transform: translateY(-2px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        
        .math-key-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.1);
        }
        
        .math-key-btn.wide {
            min-width: 100px;
        }
        
        .math-key-btn.extra-wide {
            min-width: 150px;
        }
        
        .math-key-btn.space {
            min-width: 300px;
        }
        
        .math-key-btn.operation {
            background: var(--purple-7);
        }
        
        .math-key-btn.function {
            background: var(--purple-5);
        }
        
        .math-key-btn.symbol {
            background: var(--purple-3);
        }
        
        .math-key-btn.greek {
            background: var(--purple-9);
        }
        
        .math-keyboard-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .math-category-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: #f1f3f9;
            color: #495057;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .math-category-btn.active {
            background: var(--purple-5);
            color: white;
        }
        
        .math-keyboard-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 0 10px;
        }
        
        .math-keyboard-insert {
            background: var(--purple-5);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .math-keyboard-clear {
            background: #f8f9fa;
            color: #495057;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px);}
            to { opacity: 1; transform: translateY(0);}
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast-success {
            background: #4caf50;
        }
        
        .toast-error {
            background: #f44336;
        }
        
        .toast-warning {
            background: #ff9800;
        }
        
        @keyframes slideIn {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Loading bar */
        .loading-bar {
            height: 4px;
            background: var(--purple-5);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1001;
            animation: loading 2s ease-in-out infinite;
        }
        
        @keyframes loading {
            0% { width: 0; left: 0; }
            50% { width: 100%; left: 0; }
            100% { width: 0; left: 100%; }
        }
    
    /* --- New Styles --- */
    .btn,
    .btn-secondary,
    .btn-warning,
    .latex-btn,
    .math-key-btn {
        white-space: normal !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        text-overflow: unset !important;
        line-height: 1.3 !important;
        font-size: 1rem !important;
        min-width: 0 !important;
        max-width: 100% !important;
        padding-left: 16px;
        padding-right: 16px;
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: center;
        display: inline-block;
    }

    /* Make all .action-buttons stack on small screens for clarity */
    @media (max-width: 700px) {
        .action-buttons {
            flex-direction: column !important;
            gap: 12px !important;
            align-items: stretch !important;
        }
        .btn,
        .btn-secondary,
        .btn-warning,
        .latex-btn,
        .math-key-btn {
            width: 100% !important;
            min-width: 0 !important;
            max-width: 100% !important;
            font-size: 1.05rem !important;
        }
    }
</style>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
        <div class="container-fluid d-flex flex-row justify-content-between align-items-center">
            <a class="navbar-brand" href="index.html">
                <img src="logo.png" alt="QuickQuiz Logo" class="navbar-logo-img">
                <span>QuickQuiz</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse show" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownTeachers" role="button" data-bs-toggle="dropdown">
                            For Teachers
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="create_quizes.html">Create Quizzes</a></li>
                            <li><a class="dropdown-item" href="manage_quizes.html">Manage Quizzes</a></li>
                            <li><a class="dropdown-item" href="class_tracker.html">Class Results Tracker</a></li>
                            <li><a class="dropdown-item" href="resource_bank.html">Resource Bank</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownStudents" role="button" data-bs-toggle="dropdown">
                            For Students
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="student_dashboard.html">Student Dashboard</a></li>
                            <li><a class="dropdown-item" href="quiz_portal.html">Practice Quizzes</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="aichatbot.html">AI Quiz Generator</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="signup.html">Sign Up</a>
                    </li>
                    <li class="nav-item" id="logout-nav-item" style="display:none;">
                        <a class="nav-link" href="#" id="logout-btn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <div class="ai-container">
        <div class="ai-header">
            <div class="ai-title">
                <div class="ai-icon"></div>
                Math Genius AI Assistant
                <span class="badge">Premium</span>
            </div>
            
            <div class="route-selector">
                <span class="route-label">T-Level Route:</span>
                <div class="route-dropdown">
                    <button class="route-btn" id="route-btn">
                        <span id="current-route">Digital</span>
                    </button>
                    <div class="route-options" id="route-options">
                        <div class="route-option route-digital" data-route="digital">üíª Digital</div>
                        <div class="route-option route-education" data-route="education">üë∂ Education & Early Years</div>
                        <div class="route-option route-health" data-route="health">üè• Health</div>
                        <div class="route-option route-science" data-route="science">üî¨ Science</div>
                        <div class="route-option route-business" data-route="business">üíº Business</div>
                        <div class="route-option route-accounting" data-route="accounting">üìä Accounting</div>
                        <div class="route-option route-law" data-route="law">‚öñÔ∏è Law</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="ai-content">
            <div class="ai-sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">Topics <span class="badge" id="route-badge">Digital</span></div>
                    <ul class="topic-list" id="topic-list">
                        <li class="topic-item active" data-topic="all">All Topics</li>
                        <li class="topic-item" data-topic="algebra">Algebra</li>
                        <li class="topic-item" data-topic="geometry">Geometry</li>
                        <li class="topic-item" data-topic="calculus">Calculus</li>
                        <li class="topic-item" data-topic="statistics">Statistics</li>
                        <li class="topic-item" data-topic="number-theory">Number Theory</li>
                        <li class="topic-item" data-topic="trigonometry">Trigonometry</li>
                    </ul>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">Recent Queries</div>
                    <ul class="topic-list" id="recent-queries">
                        <li class="topic-item">Solve quadratic equations</li>
                        <li class="topic-item">Find area of circle</li>
                        <li class="topic-item">Derivative of x¬≤</li>
                    </ul>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">Quick Actions</div>
                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" id="quick-generate">Generate 5 Questions</button>
                    <button class="btn btn-secondary" style="width: 100%;" id="quick-solve">Solve Problem</button>
                </div>
            </div>
            
            <div class="ai-chat">
                <div class="ai-tabs">
                    <button class="tab-btn active" data-tab="solve">Solve Problems</button>
                    <button class="tab-btn" data-tab="generate">Generate Questions</button>
                    <button class="tab-btn" data-tab="pdf">PDF Import</button>
                    <button class="tab-btn" data-tab="repository">Question Bank</button>
                </div>
                
                <!-- Solve Problems Tab -->
                <div class="tab-content active" id="solve-tab">
                    <div class="repository-connection">
                        <div class="connection-status">
                            <div class="status-indicator status-connected"></div>
                            <span>Connected to Math Repository</span>
                        </div>
                        <button class="btn btn-secondary" id="refresh-repo">Refresh</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="math-problem">Enter Math Problem:</label>
                        <textarea id="math-problem" rows="4" placeholder="Type or paste your math problem here, using LaTeX for equations (e.g., Solve $\int x^2\,dx$)"></textarea>
                    </div>
                    
                    <div class="latex-toolbar">
                        <button class="latex-btn" data-insert="\frac{}{}">Fraction</button>
                        <button class="latex-btn" data-insert="^{}">Exponent</button>
                        <button class="latex-btn" data-insert="\sqrt{}">Square Root</button>
                        <button class="latex-btn" data-insert="\int_{}^{}">Integral</button>
                        <button class="latex-btn" data-insert="\sum_{}^{}">Summation</button>
                        <button class="latex-btn" data-insert="\lim_{x \to }">Limit</button>
                        <button class="latex-btn" data-insert="\begin{pmatrix} \end{pmatrix}">Matrix</button>
                        <button class="latex-btn" data-insert="\theta">Theta</button>
                        <button class="latex-btn" data-insert="\pi">Pi</button>
                        <button class="latex-btn" id="show-keyboard">Show Keyboard</button>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn" id="solve-problem">Solve Problem</button>
                        <button class="btn btn-secondary" id="clear-problem">Clear</button>
                        <button class="btn btn-secondary" id="similar-problems">Find Similar Problems</button>
                    </div>
                    
                    <div class="processing" id="solve-processing">
                        <div class="spinner"></div>
                        <p>Analyzing problem and searching repository...</p>
                    </div>
                    
                    <div class="response-area" id="solution-preview">
                        <div class="preview-title">Solution</div>
                        <div id="solution-output"></div>
                        
                        <div class="action-buttons">
                            <button class="btn" id="create-quiz-question">Create Quiz Question</button>
                            <button class="btn btn-secondary" id="save-solution">Save to Repository</button>
                            <button class="btn btn-secondary" id="show-steps">Show Detailed Steps</button>
                        </div>
                    </div>
                </div>
                
                <!-- Generate Questions Tab -->
                <div class="tab-content" id="generate-tab">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="question-topic">Topic:</label>
                            <input type="text" id="question-topic" placeholder="E.g. Quadratic Equations, Trigonometry, Calculus">
                        </div>
                        
                        <div class="form-group">
                            <label for="generate-difficulty">Difficulty:</label>
                            <select id="generate-difficulty">
                                <option value="gcse-foundation">GCSE Foundation</option>
                                <option value="gcse-higher">GCSE Higher</option>
                                <option value="btec">BTEC</option>
                                <option value="functional-skills">Functional Skills</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="question-count">Number of Questions:</label>
                            <input type="number" id="question-count" min="1" max="20" value="5">
                        </div>
                        
                        <div class="form-group">
                            <label for="question-style">Question Style:</label>
                            <select id="question-style">
                                <option value="mixed">Mixed</option>
                                <option value="multiple-choice">Multiple Choice</option>
                                <option value="short-answer">Short Answer</option>
                                <option value="word-problem">Word Problem</option>
                                <option value="proof">Proof</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="contextualize-toggle" checked>
                            Contextualize for selected T-Level Route
                        </label>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn" id="generate-questions"><span style="margin-right:6px;">‚ú®</span>Generate Questions</button>
                        <button class="btn btn-secondary" id="generate-from-repo"><span style="margin-right:6px;">üìö</span>From Repository Topics</button>
                        <button class="btn btn-secondary" id="regenerate-for-route"><span style="margin-right:6px;">üîÑ</span>Regenerate for Route</button>
                    </div>
                    
                    <div class="processing" id="generate-processing">
                        <div class="spinner"></div>
                        <p>Generating questions from repository...</p>
                    </div>
                    
                    <div class="response-area" id="generated-questions">
                        <div class="preview-title">Generated Questions</div>
                        <div id="questions-output"></div>
                        
                        <div class="action-buttons">
                            <button class="btn" id="add-to-quiz">Add to Quiz</button>
                            <button class="btn btn-secondary" id="regenerate-questions">Regenerate</button>
                            <button class="btn btn-secondary" id="save-to-repo">Save to Repository</button>
                        </div>
                    </div>
                </div>
                
                <!-- PDF Import Tab -->
                <div class="tab-content" id="pdf-tab">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Curriculum Focus:
                                <select id="curriculum-focus">
                                    <option value="number">Number Theory</option>
                                    <option value="algebra">Algebra</option>
                                    <option value="geometry">Geometry</option>
                                    <option value="calculus">Calculus</option>
                                    <option value="statistics">Probability & Statistics</option>
                                </select>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>Contextualize for T-Level Route:
                                <select id="pdf-contextualize">
                                    <option value="none">No contextualization</option>
                                    <option value="light">Light contextualization</option>
                                    <option value="moderate">Moderate contextualization</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Upload PDF Worksheet:
                            <input type="file" id="pdf-upload" accept=".pdf">
                        </label>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn" id="process-pdf">Process PDF</button>
                        <button class="btn btn-secondary" id="connect-repo-pdf">Link to Repository</button>
                    </div>
                    
                    <div class="processing" id="pdf-processing">
                        <div class="spinner"></div>
                        <p>Extracting questions from PDF...</p>
                    </div>
                    
                    <div class="response-area" id="pdf-preview">
                        <div class="preview-title">Extracted Questions</div>
                        <div class="question-list" id="question-list"></div>
                        
                        <div class="action-buttons">
                            <button class="btn" id="rewrite-questions">Rewrite Selected</button>
                            <button class="btn btn-secondary" id="categorize-questions">Categorize</button>
                            <button class="btn btn-secondary" id="import-to-repository">Import to Repository</button>
                        </div>
                        
                        <div class="preview-box" id="rewrite-options" style="display: none;">
                            <div class="preview-title">Rewrite Options</div>
                            <div class="form-group">
                                <label>Difficulty:
                                    <select id="question-difficulty">
                                        <option value="gcse-foundation">GCSE Foundation</option>
                                        <option value="gcse-higher">GCSE Higher</option>
                                        <option value="btec">BTEC</option>
                                        <option value="functional-skills">Functional Skills</option>
                                    </select>
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Question Type:
                                    <select id="question-type">
                                        <option value="multiple-choice">Multiple Choice</option>
                                        <option value="short-answer">Short Answer</option>
                                        <option value="word-problem">Word Problem</option>
                                    </select>
                                </label>
                            </div>
                            <button class="btn" id="apply-rewrite">Apply Changes</button>
                        </div>
                    </div>
                </div>
                
                <!-- Question Bank Tab -->
                <div class="tab-content" id="repository-tab">
                    <div class="repository-connection">
                        <div class="connection-status">
                            <div class="status-indicator status-connected"></div>
                            <span>Connected to Math Question Repository</span>
                        </div>
                        <div class="action-buttons">
                            <button class="btn" id="refresh-repo2">Refresh</button>
                            <button class="btn btn-secondary" id="export-repo">Export</button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label for="repo-search">Search Repository:</label>
                            <input type="text" id="repo-search" placeholder="Search by topic, difficulty, or keywords">
                        </div>
                        <div class="form-group">
                            <label for="repo-filter">Filter by Route:
                                <select id="repo-filter">
                                    <option value="all">All Routes</option>
                                    <option value="digital">Digital</option>
                                    <option value="business">Business</option>
                                    <option value="health">Health & Social Care</option>
                                    <option value="engineering">Engineering</option>
                                    <option value="science">Science</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn" id="search-repo">Search</button>
                        <button class="btn btn-secondary" id="clear-search">Clear</button>
                        <button class="btn btn-secondary" id="filter-repo">Advanced Filter</button>
                    </div>
                    
                    <div class="processing" id="repo-processing">
                        <div class="spinner"></div>
                        <p>Searching repository...</p>
                    </div>
                    
                    <div class="response-area" id="repo-results">
                        <div class="preview-title">Repository Questions</div>
                        <div class="question-list" id="repo-questions"></div>
                        
                        <div class="action-buttons">
                            <button class="btn" id="create-quiz-from-repo">Create Quiz</button>
                            <button class="btn btn-secondary" id="edit-repo-item">Edit</button>
                            <button class="btn btn-warning" id="delete-repo-item">Delete</button>
                            <button class="btn btn-secondary" id="download-questions">Download</button>
                        </div>
                    </div>
                </div>
                
                <!-- Quiz Builder Panel (sticky at bottom) -->
                <div class="quiz-builder-panel" id="quiz-builder" style="display: none;">
                    <div class="quiz-builder-header">
                        <div class="quiz-builder-title">Quiz Builder</div>
                        <div class="quiz-count" id="quiz-count">0 questions</div>
                    </div>
                    <div class="quiz-questions-list" id="quiz-questions-list">
                        <!-- Quiz questions will be added here -->
                    </div>
                    <div class="action-buttons">
                        <button class="btn" id="save-quiz">Save Quiz</button>
                        <button class="btn btn-secondary" id="clear-quiz">Clear Quiz</button>
                        <button class="btn btn-secondary" id="preview-quiz">Preview</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="ai-footer">
        <div class="footer-container">
            <div class="footer-brand">
                <img src="logo.png" alt="QuickQuiz Logo" class="footer-logo">
                <span class="footer-title">QuickQuiz</span>
            </div>
            <div class="footer-copy">
                &copy; 2025 QuickQuiz. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- MathJax for LaTeX rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.6.0/lib/browser/math.min.js"></script>

    <!-- Mathematics Keyboard Modal -->
    <div class="math-keyboard-modal" id="math-keyboard-modal">
        <div class="math-keyboard-content">
            <button class="math-keyboard-close" id="close-math-keyboard" title="Close">&times;</button>
            <div class="math-keyboard-row">
                <button class="math-key-btn" data-insert="+">+</button>
                <button class="math-key-btn" data-insert="-">-</button>
                <button class="math-key-btn" data-insert="\\times">√ó</button>
                <button class="math-key-btn" data-insert="\\div">√∑</button>
                <button class="math-key-btn" data-insert="=">=</button>
                <button class="math-key-btn" data-insert="^{}">^</button>
                <button class="math-key-btn" data-insert="\\sqrt{}">‚àö</button>
                <button class="math-key-btn" data-insert="\\frac{}{}">a‚ÅÑb</button>
                <button class="math-key-btn" data-insert="\\pi">œÄ</button>
                <button class="math-key-btn" data-insert="\\infty">‚àû</button>
                <button class="math-key-btn" data-insert="\\int_{}^{}">‚à´</button>
                <button class="math-key-btn" data-insert="\\sum_{}^{}">‚àë</button>
                <button class="math-key-btn" data-insert="\\lim_{x \\to }">lim</button>
                <button class="math-key-btn" data-insert="\\sin">sin</button>
                <button class="math-key-btn" data-insert="\\cos">cos</button>
                <button class="math-key-btn" data-insert="\\tan">tan</button>
                <button class="math-key-btn" data-insert="\\log">log</button>
                <button class="math-key-btn" data-insert="\\ln">ln</button>
                <button class="math-key-btn" data-insert="\\left(\\right)">()</button>
                <button class="math-key-btn" data-insert="\\left[\\right]">[]</button>
                <button class="math-key-btn" data-insert="\\left\\{\\right\\}">{}</button>
            </div>
        </div>
    </div>

    <script>
    // --- Global Variables ---
    let currentRoute = 'digital';
    let quizQuestions = [];
    let mathKeyboardTarget = null;
    let selectedTopic = 'all';
    
    // Sample repository data
    const mathRepository = {
        questions: [
            {
                question: "Solve for x: 2x + 5 = 15",
                solution: "x = 5",
                topic: "algebra",
                difficulty: "gcse-foundation",
                route: "all"
            },
            {
                question: "Find the area of a circle with radius 5cm",
                solution: "Area = œÄr¬≤ = 25œÄ cm¬≤",
                topic: "geometry",
                difficulty: "gcse-higher",
                route: "all"
            },
            {
                question: "Calculate the derivative of f(x) = 3x¬≤ + 2x - 5",
                solution: "f'(x) = 6x + 2",
                topic: "calculus",
                difficulty: "btec",
                route: "all"
            }
        ],
        userQuestions: []
    };
    
    // --- Utility Functions ---
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    function showLoading(show = true) {
        document.getElementById('loading-bar').style.display = show ? 'block' : 'none';
    }
    
    function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    // --- Math Keyboard Logic (unchanged) ---
    function showMathKeyboard(target) {
        mathKeyboardTarget = target;
        document.getElementById('math-keyboard-modal').style.display = 'flex';
    }
    function hideMathKeyboard() {
        document.getElementById('math-keyboard-modal').style.display = 'none';
        mathKeyboardTarget = null;
    }
    document.getElementById('close-math-keyboard').onclick = hideMathKeyboard;
    document.getElementById('show-keyboard').addEventListener('click', () => {
        showMathKeyboard(document.getElementById('math-problem'));
    });
    document.querySelectorAll('.math-key-btn').forEach(btn => {
        btn.onclick = function() {
            if (!mathKeyboardTarget) return;
            const insert = btn.getAttribute('data-insert');
            const el = mathKeyboardTarget;
            if (el.setRangeText) {
                const start = el.selectionStart, end = el.selectionEnd;
                el.setRangeText(insert, start, end, 'end');
                el.focus();
                el.selectionStart = el.selectionEnd = start + insert.length;
            } else {
                el.value += insert;
                el.focus();
            }
            if (el.dispatchEvent) el.dispatchEvent(new Event('input'));
        };
    });
    
    // --- Route Selector (unchanged) ---
    document.getElementById('route-btn').addEventListener('click', function() {
        document.getElementById('route-options').classList.toggle('show');
    });
    document.querySelectorAll('.route-option').forEach(option => {
        option.addEventListener('click', function() {
            const route = this.getAttribute('data-route');
            currentRoute = route;
            document.getElementById('current-route').textContent = this.textContent.trim();
            document.getElementById('route-badge').textContent = this.textContent.trim();
            // Update badge color
            const badge = document.getElementById('route-badge');
            badge.style.backgroundColor =
                route === 'digital' ? 'var(--digital-color)' :
                route === 'business' ? 'var(--business-color)' :
                route === 'health' ? 'var(--health-color)' :
                route === 'engineering' ? 'var(--engineering-color)' :
                route === 'science' ? 'var(--science-color)' :
                route === 'education' ? 'var(--education-color)' :
                route === 'accounting' ? 'var(--accounting-color)' : 'var(--law-color)';
            document.getElementById('route-options').classList.remove('show');
            showToast(`Route changed to ${this.textContent.trim()}`, 'success');
        });
    });
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.route-dropdown')) {
            document.getElementById('route-options').classList.remove('show');
        }
    });
    
    // --- Tab Switching (unchanged) ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(tabBtn => {
                tabBtn.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
            this.classList.add('active');
            showToast(`Switched to ${this.textContent.trim()} tab`, 'success');
        });
    });
    
    // --- Topic Selection (unchanged) ---
    document.querySelectorAll('.topic-item[data-topic]').forEach(item => {
        item.addEventListener('click', function() {
            document.querySelectorAll('.topic-item').forEach(topic => {
                topic.classList.remove('active');
            });
            this.classList.add('active');
            selectedTopic = this.getAttribute('data-topic');
            showToast(`Selected topic: ${this.textContent.trim()}`, 'success');
        });
    });
    
    // --- Quiz Builder Functionality (unchanged) ---
    function updateQuizBuilder() {
        const quizBuilder = document.getElementById('quiz-builder');
        const quizCount = document.getElementById('quiz-count');
        const quizList = document.getElementById('quiz-questions-list');
        
        if (quizQuestions.length > 0) {
            quizBuilder.style.display = 'block';
            quizCount.textContent = `${quizQuestions.length} question${quizQuestions.length !== 1 ? 's' : ''}`;
            
            quizList.innerHTML = '';
            quizQuestions.forEach((q, i) => {
                const questionItem = document.createElement('div');
                questionItem.className = 'quiz-question-item';
                questionItem.innerHTML = `
                    <div>${i+1}. ${q.question}</div>
                    <button class="remove-question-btn" data-index="${i}">√ó</button>
                `;
                quizList.appendChild(questionItem);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-question-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    quizQuestions.splice(index, 1);
                    updateQuizBuilder();
                    showToast('Question removed from quiz', 'success');
                });
            });
        } else {
            quizBuilder.style.display = 'none';
        }
    }
    
    // Add question to quiz
    function addQuestionToQuiz(question) {
        quizQuestions.push({
            question: question,
            route: currentRoute,
            topic: selectedTopic
        });
        updateQuizBuilder();
        showToast('Question added to quiz builder!', 'success');
    }
    
    // Clear quiz
    document.getElementById('clear-quiz').addEventListener('click', function() {
        quizQuestions = [];
        updateQuizBuilder();
        showToast('Quiz cleared', 'success');
    });
    
    // Save quiz
    document.getElementById('save-quiz').addEventListener('click', function() {
        if (quizQuestions.length === 0) {
            showToast('Please add questions to your quiz first.', 'error');
            return;
        }
        
        showLoading(true);
        setTimeout(() => {
            // In a real app, this would save to a database
            const quizName = prompt('Enter a name for your quiz:', `Math Quiz - ${new Date().toLocaleDateString()}`);
            if (quizName) {
                showToast(`Quiz "${quizName}" saved successfully with ${quizQuestions.length} questions!`, 'success');
                quizQuestions = [];
                updateQuizBuilder();
            }
            showLoading(false);
        }, 1000);
    });
    
    // Preview quiz
    document.getElementById('preview-quiz').addEventListener('click', function() {
        if (quizQuestions.length === 0) {
            showToast('Please add questions to your quiz first.', 'error');
            return;
        }
        
        let previewContent = '<div style="padding: 20px; max-width: 800px; margin: 0 auto;">';
        previewContent += `<h2 style="color: var(--primary-color); text-align: center;">Quiz Preview</h2>`;
        previewContent += `<p style="text-align: center; margin-bottom: 30px;">T-Level Route: ${currentRoute.charAt(0).toUpperCase() + currentRoute.slice(1)}</p>`;
        
        quizQuestions.forEach((q, i) => {
            previewContent += `<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;">`;
            previewContent += `<h3 style="margin-bottom: 10px;">Question ${i+1}:</h3>`;
            previewContent += `<div>${q.question}</div>`;
            previewContent += `</div>`;
        });
        
        previewContent += '</div>';
        
        const previewWindow = window.open('', '_blank', 'width=900,height=600');
        previewWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Quiz Preview</title>
                <style>
                    body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }
                    .math { font-size: 1.1em; }
                </style>
                <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"><\/script>
                <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
            </head>
            <body>
                ${previewContent}
            </body>
            </html>
        `);
        previewWindow.document.close();
    });
    
    // --- Math Problem Solver (unchanged) ---
    function solveMathProblem(problem) {
        try {
            if (problem.startsWith("Solve for x:") || problem.includes("=")) {
                const expr = problem.replace("Solve for x:", "").trim();
                const solution = math.simplify(expr).toString();
                return {
                    solution: `\\[ ${solution} \\]`,
                    steps: [
                        `Original equation: \\[ ${expr} \\]`,
                        `Simplified solution: \\[ ${solution} \\]`
                    ]
                };
            }
            if (problem.includes("derivative of")) {
                const expr = problem.replace("Find the derivative of", "")
                                   .replace("Calculate the derivative of", "")
                                   .trim();
                const derivative = math.derivative(expr, 'x').toString();
                return {
                    solution: `\\[ \\frac{d}{dx}(${expr}) = ${derivative} \\]`,
                    steps: [
                        `Original function: \\[ ${expr} \\]`,
                        `Derivative: \\[ ${derivative} \\]`
                    ]
                };
            }
            if (problem.includes("integral of")) {
                const expr = problem.replace("Find the integral of", "")
                                   .replace("Calculate the integral of", "")
                                   .trim();
                const integral = math.integral(expr, 'x').toString();
                return {
                    solution: `\\[ \\int ${expr}\\,dx = ${integral} + C \\]`,
                    steps: [
                        `Integrand: \\[ ${expr} \\]`,
                        `Antiderivative: \\[ ${integral} + C \\]`
                    ]
                };
            }
            return {
                solution: "Could not automatically solve this problem. The AI would provide a detailed solution here.",
                steps: [
                    "Step 1: Analyze the problem structure",
                    "Step 2: Apply appropriate mathematical methods",
                    "Step 3: Verify the solution"
                ]
            };
        } catch (error) {
            return {
                solution: "Error solving problem: " + error.message,
                steps: ["An error occurred while solving this problem"]
            };
        }
    }
    document.getElementById('solve-problem').addEventListener('click', function() {
        const problem = document.getElementById('math-problem').value.trim();
        if (!problem) {
            showToast('Please enter a math problem to solve.', 'error');
            return;
        }
        
        document.getElementById('solve-processing').style.display = 'block';
        document.getElementById('solution-preview').style.display = 'none';
        
        setTimeout(() => {
            document.getElementById('solve-processing').style.display = 'none';
            
            // Solve using math.js
            const result = solveMathProblem(problem);
            
            // Find similar problems in repository
            const similarProblems = [...mathRepository.questions, ...mathRepository.userQuestions]
                .filter(q => q.question.includes(problem.substring(0, 10)) || 
                       q.topic.includes(problem.split(' ')[0]))
                .slice(0, 3);
            
            let solutionHTML = `<b>Problem:</b> <span>${problem}</span><br><br>`;
            solutionHTML += `<b>Solution:</b> ${result.solution}<br><br>`;
            
            if (result.steps) {
                solutionHTML += `<details><summary>Show Steps</summary><ol>`;
                result.steps.forEach(step => {
                    solutionHTML += `<li>${step}</li>`;
                });
                solutionHTML += `</ol></details>`;
            }
            
            if (similarProblems.length > 0) {
                solutionHTML += `<br><b>Similar Problems:</b><ul style="margin-top:10px;">`;
                similarProblems.forEach(p => {
                    solutionHTML += `<li>${p.question} <span class="topic-tag">${p.topic}</span></li>`;
                });
                solutionHTML += `</ul>`;
            }
            
            document.getElementById('solution-output').innerHTML = solutionHTML;
            document.getElementById('solution-preview').style.display = 'block';
            MathJax.typesetPromise();
        }, 1500);
    });

    document.getElementById('clear-problem').addEventListener('click', function() {
        document.getElementById('math-problem').value = '';
        document.getElementById('solution-preview').style.display = 'none';
        showToast('Problem cleared', 'success');
    });

    document.getElementById('similar-problems').addEventListener('click', function() {
        const problem = document.getElementById('math-problem').value.trim();
        if (!problem) {
            showToast('Please enter a math problem first.', 'error');
            return;
        }
        
        // Find similar problems in repository
        const similarProblems = [...mathRepository.questions, ...mathRepository.userQuestions].filter(q => 
            q.question.includes(problem.substring(0, 10)) || 
            q.topic.includes(problem.split(' ')[0])
        ).slice(0, 3);
        
        if (similarProblems.length > 0) {
            let similarHTML = '<b>Similar Problems:</b><ul style="margin-top:10px;">';
            similarProblems.forEach(p => {
                similarHTML += `<li>${p.question} <span class="topic-tag">${p.topic}</span></li>`;
            });
            similarHTML += '</ul>';
            document.getElementById('solution-output').innerHTML = similarHTML;
            document.getElementById('solution-preview').style.display = 'block';
            MathJax.typesetPromise();
        } else {
            showToast('No similar problems found in repository.', 'warning');
        }
    });

    document.getElementById('create-quiz-question').addEventListener('click', function() {
        const problem = document.getElementById('math-problem').value.trim();
        if (!problem) {
            showToast('No problem to add to quiz.', 'error');
            return;
        }
        
        addQuestionToQuiz(problem);
    });

    document.getElementById('save-solution').addEventListener('click', function() {
        const problem = document.getElementById('math-problem').value.trim();
        if (!problem) {
            showToast('No problem to save.', 'error');
            return;
        }
 
        
        // In a real app, this would prompt for more details
        const topic = prompt("Enter topic for this problem:", selectedTopic || currentRoute || "general");
        if (topic) {
            const subtopic = prompt("Enter subtopic:", "equations");
            const difficulty = prompt("Enter difficulty (basic/intermediate/advanced):", "intermediate");
            
            // Save to user repository
            mathRepository.userQuestions.push({
                question: problem,
                solution: document.getElementById('solution-output').textContent,
                topic: topic,
                subtopic: subtopic,
                difficulty: difficulty,
                route: currentRoute
            });
            
            showToast('Problem saved to your repository!', 'success');
        }
    });

    document.getElementById('show-steps').addEventListener('click', function() {
        showToast('Detailed steps would be displayed here.', 'info');
    });

    // --- Question Generation ---
    // If topic is blank, use route or "General"
    function generateQuestions(topic, difficulty, count, style, contextualize) {
        const questions = [];
        const contextualTemplates = {
            digital: {
                "gcse-foundation": [
                    () => `A computer processes data at ${randomInt(2, 10)}GB per second. How much data in ${randomInt(5, 15)} seconds?`,
                    () => `A website receives ${randomInt(100, 500)} visitors per hour. How many in ${randomInt(2, 8)} hours?`,
                    () => `A file of ${randomInt(200, 800)}MB downloads in ${randomInt(2, 10)} minutes. What is the average speed?`,
                    () => `A printer prints ${randomInt(10, 50)} pages per minute. How many in ${randomInt(5, 20)} minutes?`,
                    () => `A USB stick holds ${randomInt(8, 64)}GB. How many ${randomInt(2, 8)}GB files can it store?`,
                    () => `A digital camera takes ${randomInt(100, 500)} photos. If each photo is ${randomInt(2, 8)}MB, what is the total size?`,
                    () => `A video is ${randomInt(10, 60)} minutes long. If it uses ${randomInt(2, 5)}GB per 10 minutes, what is the total size?`,
                    () => `A student types ${randomInt(20, 60)} words per minute. How many words in ${randomInt(10, 30)} minutes?`,
                    () => `A battery lasts ${randomInt(2, 10)} hours. How many minutes is this?`,
                    () => `A download speed is ${randomInt(10, 100)}Mbps. How long to download a ${randomInt(100, 500)}MB file?`,
                    () => `A folder contains ${randomInt(10, 50)} files, each ${randomInt(2, 10)}MB. What is the total size?`,
                    () => `A computer costs ¬£${randomInt(200, 800)}. How much for ${randomInt(2, 6)} computers?`,
                    () => `A class has ${randomInt(10, 30)} students. Each needs ${randomInt(1, 3)}GB of storage. Total storage needed?`,
                    () => `A monitor uses ${randomInt(20, 100)}W per hour. How much energy in ${randomInt(5, 15)} hours?`,
                    () => `A keyboard costs ¬£${randomInt(10, 50)}. How much for ${randomInt(5, 20)} keyboards?`,
                    () => `A software update takes ${randomInt(10, 60)} minutes per device. How long for ${randomInt(5, 15)} devices?`,
                    () => `A student spends ${randomInt(1, 3)} hours daily on a computer. How many hours in a week?`,
                    () => `A file is split into ${randomInt(2, 10)} equal parts. If the file is ${randomInt(100, 500)}MB, how big is each part?`,
                    () => `A USB stick costs ¬£${randomInt(5, 20)}. How much for ${randomInt(3, 10)} sticks?`,
                    () => `A computer lab has ${randomInt(10, 30)} computers. Each uses ${randomInt(50, 150)}W. What is the total power usage?`
                ],
                "gcse-higher": [
                    () => `A network transmits data at ${randomInt(50, 200)}Mbps. Time to transfer ${randomInt(1, 10)}GB?`,
                    () => `A server has ${randomInt(8, 64)}GB RAM and runs ${randomInt(2, 8)} VMs. RAM per VM?`,
                    () => `A database grows by ${randomInt(5, 20)}% monthly. Starts at ${randomInt(10, 50)}GB. Size after 2 months?`,
                    () => `A computer program runs ${randomInt(1000, 5000)} times per hour. How many in ${randomInt(2, 8)} hours?`,
                    () => `A backup takes ${randomInt(30, 120)} minutes. How many backups in ${randomInt(5, 10)} hours?`,
                    () => `A file compresses from ${randomInt(500, 2000)}MB to ${randomInt(100, 400)}MB. What is the percentage reduction?`,
                    () => `A network has ${randomInt(10, 50)} devices. Each device uses ${randomInt(2, 8)}GB per day. Total usage?`,
                    () => `A server processes ${randomInt(10000, 50000)} requests per day. How many per hour?`,
                    () => `A download speed increases by ${randomInt(10, 50)}%. If it was ${randomInt(10, 100)}Mbps, what is it now?`,
                    () => `A computer's value depreciates by ${randomInt(10, 30)}% per year. If it costs ¬£${randomInt(500, 2000)}, what is its value after 1 year?`,
                    () => `A software license costs ¬£${randomInt(50, 200)} per user. How much for ${randomInt(10, 50)} users?`,
                    () => `A data center uses ${randomInt(1000, 5000)}kWh per month. What is the average daily usage?`,
                    () => `A software license costs ¬£${randomInt(50, 200)} per user. How much for ${randomInt(10, 50)} users?`,
                    () => `A data center uses ${randomInt(1000, 5000)}kWh per month. What is the average daily usage?`,
                    () => `A file is split into ${randomInt(4, 10)} equal parts. If the file is ${randomInt(400, 1000)}MB, how big is each part?`,
                    () => `A student spends ${randomInt(2, 6)} hours daily on a computer. How many hours in a month?`,
                    () => `A network upgrade costs ¬£${randomInt(1000, 5000)}. If split among ${randomInt(10, 50)} users, how much per user?`,
                    () => `A server runs ${randomInt(24, 168)} hours per week. How many hours per month?`,
                    () => `A computer lab has ${randomInt(20, 60)} computers. Each uses ${randomInt(100, 300)}W. What is the total power usage?`,
                    () => `A software update takes ${randomInt(15, 90)} minutes per device. How long for ${randomInt(10, 30)} devices?`,
                    () => `A digital project takes ${randomInt(2, 8)} weeks to complete. If the team works ${randomInt(20, 40)} hours per week, how many hours in total?`,
                    () => `A website's traffic increases by ${randomInt(10, 50)}% each month. If it starts at ${randomInt(1000, 5000)} visitors, how many after 1 month?`
                ],
                "btec": [
                    () => `A technician installs ${randomInt(5, 20)} computers. Each computer costs ¬£${randomInt(200, 800)}. What is the total cost?`,
                    () => `A digital project takes ${randomInt(2, 6)} weeks to complete. If the team works ${randomInt(20, 40)} hours per week, how many hours in total?`,
                    () => `A software license costs ¬£${randomInt(50, 200)} per user. How much for ${randomInt(5, 15)} users?`,
                    () => `A printer prints ${randomInt(10, 50)} pages per minute. How many in ${randomInt(5, 20)} minutes?`,
                    () => `A USB stick holds ${randomInt(8, 64)}GB. How many ${randomInt(2, 8)}GB files can it store?`,
                    () => `A digital camera takes ${randomInt(100, 500)} photos. If each photo is ${randomInt(2, 8)}MB, what is the total size?`,
                    () => `A video is ${randomInt(10, 60)} minutes long. If it uses ${randomInt(2, 5)}GB per 10 minutes, what is the total size?`,
                    () => `A student types ${randomInt(20, 60)} words per minute. How many words in ${randomInt(10, 30)} minutes?`,
                    () => `A battery lasts ${randomInt(2, 10)} hours. How many minutes is this?`,
                    () => `A download speed is ${randomInt(10, 100)}Mbps. How long to download a ${randomInt(100, 500)}MB file?`,
                    () => `A folder contains ${randomInt(10, 50)} files, each ${randomInt(2, 10)}MB. What is the total size?`,
                    () => `A computer costs ¬£${randomInt(200, 800)}. How much for ${randomInt(2, 6)} computers?`,
                    () => `A class has ${randomInt(10, 30)} students. Each needs ${randomInt(1, 3)}GB of storage. Total storage needed?`,
                    () => `A monitor uses ${randomInt(20, 100)}W per hour. How much energy in ${randomInt(5, 15)} hours?`,
                    () => `A keyboard costs ¬£${randomInt(10, 50)}. How much for ${randomInt(5, 20)} keyboards?`,
                    () => `A software update takes ${randomInt(10, 60)} minutes per device. How long for ${randomInt(5, 15)} devices?`,
                    () => `A student spends ${randomInt(1, 3)} hours daily on a computer. How many hours in a week?`,
                    () => `A file is split into ${randomInt(2, 10)} equal parts. If the file is ${randomInt(100, 500)}MB, how big is each part?`,
                    () => `A USB stick costs ¬£${randomInt(5, 20)}. How much for ${randomInt(3, 10)} sticks?`,
                    () => `A computer lab has ${randomInt(10, 30)} computers. Each uses ${randomInt(50, 150)}W. What is the total power usage?`
                ],
                "functional-skills": [
                    () => `A printer prints ${randomInt(10, 50)} pages per minute. How many in ${randomInt(5, 20)} minutes?`,
                    () => `A USB stick holds ${randomInt(8, 64)}GB. How many ${randomInt(2, 8)}GB files can it store?`,
                    () => `You have ${randomInt(10, 50)} emails to send. If each takes ${randomInt(1, 3)} minutes, total time?`,
                    () => `A computer costs ¬£${randomInt(200, 800)}. How much for ${randomInt(2, 6)} computers?`,
                    () => `A student spends ${randomInt(1, 3)} hours daily on a computer. How many hours in a week?`,
                    () => `A file is split into ${randomInt(2, 10)} equal parts. If the file is ${randomInt(100, 500)}MB, how big is each part?`,
                    () => `A USB stick costs ¬£${randomInt(5, 20)}. How much for ${randomInt(3, 10)} sticks?`,
                    () => `A computer lab has ${randomInt(10, 30)} computers. Each uses ${randomInt(50, 150)}W. What is the total power usage?`,
                    () => `A student types ${randomInt(20, 60)} words per minute. How many words in ${randomInt(10, 30)} minutes?`,
                    () => `A battery lasts ${randomInt(2, 10)} hours. How many minutes is this?`,
                    () => `A download speed is ${randomInt(10, 100)}Mbps. How long to download a ${randomInt(100, 500)}MB file?`,
                    () => `A folder contains ${randomInt(10, 50)} files, each ${randomInt(2, 10)}MB. What is the total size?`,
                    () => `A digital camera takes ${randomInt(100, 500)} photos. If each photo is ${randomInt(2, 8)}MB, what is the total size?`,
                    () => `A video is ${randomInt(10, 60)} minutes long. If it uses ${randomInt(2, 5)}GB per 10 minutes, what is the total size?`,
                    () => `A monitor uses ${randomInt(20, 100)}W per hour. How much energy in ${randomInt(5, 15)} hours?`,
                    () => `A keyboard costs ¬£${randomInt(10, 50)}. How much for ${randomInt(5, 20)} keyboards?`,
                    () => `A software update takes ${randomInt(10, 60)} minutes per device. How long for ${randomInt(5, 15)} devices?`,
                    () => `A class has ${randomInt(10, 30)} students. Each needs ${randomInt(1, 3)}GB of storage. Total storage needed?`,
                    () => `A network has ${randomInt(10, 50)} devices. Each device uses ${randomInt(2, 8)}GB per day. Total usage?`,
                    () => `A backup takes ${randomInt(30, 120)} minutes. How many backups in ${randomInt(5, 10)} hours?`
                ]
            },

            business: {
                "btec": [
                    () => `A business course has ${randomInt(10, 30)} students. Each pays ¬£${randomInt(100, 500)}. What is the total income?`,
                    () => `A manager schedules ${randomInt(5, 15)} meetings per week. How many in a month?`,
                    () => `A company spends ¬£${randomInt(500, 2000)} on advertising. If sales increase by ${randomInt(10, 50)} units, what is the cost per unit increase?`,
                    () => `A shop sells ${randomInt(10, 50)} items per day. How many in a week?`,
                    () => `A product costs ¬£${randomInt(5, 20)} to make and sells for ¬£${randomInt(21, 40)}. What is the profit per item?`,
                    () => `A business has fixed costs of ¬£${randomInt(1000, 3000)} and variable costs of ¬£${randomInt(2, 10)} per unit. What is the total cost for ${randomInt(50, 200)} units?`,
                    () => `A loan of ¬£${randomInt(1000, 5000)} is repaid over ${randomInt(12, 36)} months. What is the monthly payment?`,
                    () => `A discount of ${randomInt(5, 25)}% is given on a ¬£${randomInt(50, 200)} item. What is the sale price?`,
                    () => `A business increases sales by ${randomInt(5, 20)}% each year. If sales are ¬£${randomInt(1000, 5000)} this year, what are they next year?`,
                    () => `A worker travels ${randomInt(10, 50)} miles per day. How many in a month?`,
                    () => `A worker earns ¬£${randomInt(7, 15)} per hour for ${randomInt(20, 40)} hours. What is the weekly wage?`,
                    () => `A product's price rises from ¬£${randomInt(10, 20)} to ¬£${randomInt(21, 40)}. What is the percentage increase?`,
                    () => `A business makes a profit of ¬£${randomInt(100, 1000)} on sales of ¬£${randomInt(1000, 5000)}. What is the profit margin?`,
                    () => `A shop's rent is ¬£${randomInt(500, 1500)} per month. What is the annual rent?`,
                    () => `A company has ${randomInt(10, 50)} employees. Each is paid ¬£${randomInt(200, 500)} per week. What is the total wage bill?`,
                    () => `A business borrows ¬£${randomInt(1000, 5000)} at ${randomInt(2, 10)}% interest. What is the interest after one year?`,
                    () => `A product is reduced by ${randomInt(10, 50)}%. If it was ¬£${randomInt(20, 100)}, what is the new price?`,
                    () => `A shop sells ${randomInt(100, 500)} items at a profit of ¬£${randomInt(1, 5)} each. What is the total profit?`,
                    () => `A business day lasts ${randomInt(6, 10)} hours. How many hours in a 5-day week?`,
                    () => `A cashier gives change from ¬£${randomInt(5, 20)} for an item costing ¬£${randomInt(1, 4)}. How much change?`
                ],
                "functional-skills": [
                    () => `A shop sells ${randomInt(10, 50)} items per day. How many in a week?`,
                    () => `A cashier gives change from ¬£${randomInt(5, 20)} for an item costing ¬£${randomInt(1, 4)}. How much change?`,
                    () => `A business day lasts ${randomInt(6, 10)} hours. How many hours in a 5-day week?`,
                    () => `A shop sells ${randomInt(10, 50)} items at ¬£${randomInt(1, 5)} each. What is the total sales?`,
                    () => `A worker earns ¬£${randomInt(7, 15)} per hour for ${randomInt(20, 40)} hours. What is the weekly wage?`,
                    () => `A discount of ${randomInt(5, 25)}% is given on a ¬£${randomInt(50, 200)} item. What is the sale price?`,
                    () => `A worker travels ${randomInt(10, 50)} miles per day. How many in a month?`,
                    () => `A product's price rises from ¬£${randomInt(10, 20)} to ¬£${randomInt(21, 40)}. What is the percentage increase?`,
                    () => `A shop's rent is ¬£${randomInt(500, 1500)} per month. What is the annual rent?`,
                    () => `A business borrows ¬£${randomInt(1000, 5000)} at ${randomInt(2, 10)}% interest. What is the interest after one year?`,
                    () => `A shop sells ${randomInt(100, 500)} items at a profit of ¬£${randomInt(1, 5)} each. What is the total profit?`,
                    () => `A cashier gives change from ¬£${randomInt(5, 20)} for an item costing ¬£${randomInt(1, 4)}. How much change?`,
                ]
            },

            education: {
                "btec": [
                    () => `A college has ${randomInt(10, 30)} courses, each with ${randomInt(15, 30)} students. Total students?`,
                    () => `A student attends ${randomInt(5, 10)} classes per week. How many in a term of ${randomInt(8, 16)} weeks?`,
                    () => `A teacher prepares ${randomInt(8, 20)} lessons per week. How many in a term of ${randomInt(8, 16)} weeks?`,
                    () => `A classroom has ${randomInt(20, 35)} desks. If ${randomInt(5, 15)} are broken, how many are usable?`,
                    () => `A teacher marks ${randomInt(20, 50)} papers per hour. How many in ${randomInt(2, 6)} hours?`,
                    () => `A school has ${randomInt(10, 30)} classes, each with ${randomInt(20, 35)} students. Total students?`,
                    () => `A student reads ${randomInt(10, 30)} pages per day. How many in a week?`,
                    () => `A teacher prepares ${randomInt(5, 15)} lessons per week. How many in a term of ${randomInt(8, 16)} weeks?`,
                    () => `A student spends ${randomInt(1, 3)} hours daily on homework. How many hours in a week?`,
                    () => `A school trip costs ¬£${randomInt(10, 50)} per student. How much for ${randomInt(20, 40)} students?`,
                    () => `A library has ${randomInt(1000, 5000)} books. If ${randomInt(10, 50)}% are fiction, how many are fiction?`,
                    () => `A teacher grades ${randomInt(5, 20)} papers per hour. How many in a 7-hour workday?`,
                    () => `A student studies for ${randomInt(1, 3)} hours daily. How many hours in a school week (5 days)?`,
                    () => `A school has ${randomInt(5, 10)} classes per day. If each class has ${randomInt(20, 30)} students, what is the total number of students?`,
                    () => `A teacher marks ${randomInt(30, 80)} papers per hour. How many in ${randomInt(3, 8)} hours?`,
                    () => `A student reads ${randomInt(20, 60)} pages per day. How many in a month?`,
                    () => `A classroom has ${randomInt(20, 35)} desks. If ${randomInt(5, 15)} are broken, how many are usable?`,
                    () => `A student spends ${randomInt(1, 3)} hours daily on homework. How many hours in a week?`
                ],
                "functional-skills": [
                    () => `A student reads ${randomInt(10, 30)} pages per day. How many in a week?`,
                    () => `A teacher prepares ${randomInt(5, 15)} lessons per week. How many in a term of ${randomInt(8, 16)} weeks?`,
                    () => `A classroom has ${randomInt(20, 35)} desks. If ${randomInt(5, 15)} are broken, how many are usable?`,
                    () => `A teacher marks ${randomInt(20, 50)} papers per hour. How many in ${randomInt(2, 6)} hours?`,
                    () => `A school has ${randomInt(10, 30)} classes, each with ${randomInt(20, 35)} students. Total students?`,
                    () => `A student spends ${randomInt(1, 3)} hours daily on homework. How many hours in a week?`,
                    () => `A school trip costs ¬£${randomInt(10, 50)} per student. How much for ${randomInt(20, 40)} students?`,
                    () => `A library has ${randomInt(1000, 5000)} books. If ${randomInt(10, 50)}% are fiction, how many are fiction?`,
                    () => `A teacher grades ${randomInt(5, 20)} papers per hour. How many in a 7-hour workday?`,
                    () => `A student studies for ${randomInt(1, 3)} hours daily. How many hours in a school week (5 days)?`,
                    () => `A recipe for a science experiment calls for ${randomInt(1, 5)} liters of vinegar. How many milliliters is that?`,
                    () => `A school has ${randomInt(5, 10)} classes per day. If each class has ${randomInt(20, 30)} students, what is the total number of students?`,
                    () => `A teacher marks ${randomInt(30, 80)} papers per hour. How many in ${randomInt(3, 8)} hours?`,
                    () => `A student reads ${randomInt(20, 60)} pages per day. How many in a month?`,
                    () => `A teacher prepares ${randomInt(8, 20)} lessons per week. How many in a term of ${randomInt(8, 16)} weeks?`,
                    () => `A classroom has ${randomInt(20, 35)} desks. If ${randomInt(5, 15)} are broken, how many are usable?`,
                    () => `A student spends ${randomInt(1, 3)} hours daily on homework. How many hours in a week?`,
                    () => `A school trip costs ¬£${randomInt(10, 50)} per student. How much for ${randomInt(20, 40)} students?`,
                    () => `A library has ${randomInt(1000, 5000)} books. If ${randomInt(10, 50)}% are fiction, how many are fiction?`,
                    () => `A teacher grades ${randomInt(5, 20)} papers per hour. How many in a 7-hour workday?`
                ]
            },

            law: {
                "btec": [
                    () => `A legal assistant files ${randomInt(10, 40)} documents per day. How many in a week?`,
                    () => `A law student reads ${randomInt(30, 80)} pages per day. How many in a month?`,
                    () => `A court fine is ¬£${randomInt(100, 1000)}. If paid in ${randomInt(2, 10)} installments, how much per installment?`,
                    () => `A law firm has ${randomInt(5, 20)} lawyers, each handling ${randomInt(10, 30)} cases. Total cases?`,
                    () => `A judge's salary increases by ${randomInt(2, 10)}% from ¬£${randomInt(40000, 90000)}. What is the new salary?`,
                    () => `A legal document is ${randomInt(100, 500)} pages. If reviewed at ${randomInt(10, 30)} pages per hour, how many hours to review?`,
                    () => `A legal assistant earns ¬£${randomInt(8, 15)} per hour for ${randomInt(20, 40)} hours. What is the weekly wage?`,
                    () => `A law course lasts ${randomInt(6, 12)} months. How many weeks is this?`,
                    () => `A judge hears ${randomInt(5, 20)} cases per day. How many in a month?`,
                    () => `A lawyer travels ${randomInt(10, 50)} miles per day. How many in a week?`,
                    () => `A law firm spends ¬£${randomInt(500, 2000)} on research. If this results in ${randomInt(10, 50)} new cases, what is the cost per case?`,
                    () => `A legal textbook has ${randomInt(200, 800)} pages. If a student reads ${randomInt(20, 40)} pages per day, how many days to finish?`,
                    () => `A contract lasts ${randomInt(6, 24)} months. How many years is this?`,
                    () => `A fine is ¬£${randomInt(50, 500)}. If paid in ${randomInt(2, 10)} installments, how much per installment?`,
                    () => `A law exam has ${randomInt(50, 100)} questions. If a student answers ${randomInt(10, 20)} per hour, how many hours to finish?`,
                    () => `A legal secretary types ${randomInt(30, 60)} words per minute. How many words in ${randomInt(10, 30)} minutes?`,
                    () => `A law library has ${randomInt(1000, 5000)} books. If ${randomInt(10, 50)}% are on criminal law, how many is that?`,
                    () => `A lawyer bills ¬£${randomInt(50, 200)} per hour. How much for ${randomInt(5, 15)} hours?`,
                    () => `A legal team works ${randomInt(20, 40)} hours per week. How many hours in a year?`,
                    () => `A judge's gavel costs ¬£${randomInt(10, 50)}. If bought in sets of 5, cost per gavel?`
                ],
                "functional-skills": [
                    () => `A court hears ${randomInt(5, 20)} cases per day. How many in a week?`,
                    () => `A lawyer studies ${randomInt(2, 8)} cases simultaneously. If each case takes ${randomInt(10, 30)} hours, total hours?`,
                    () => `A judge's gavel costs ¬£${randomInt(10, 50)}. If bought in sets of 5, cost per gavel?`,
                    () => `A legal assistant earns ¬£${randomInt(8, 15)} per hour for ${randomInt(20, 40)} hours. What is the weekly wage?`,
                    () => `A law course lasts ${randomInt(6, 12)} months. How many weeks is this?`,
                    () => `A judge hears ${randomInt(5, 20)} cases per day. How many in a month?`,
                    () => `A lawyer travels ${randomInt(10, 50)} miles per day. How many in a week?`,
                    () => `A law firm spends ¬£${randomInt(500, 2000)} on research. If this results in ${randomInt(10, 50)} new cases, what is the cost per case?`,
                    () => `A legal textbook has ${randomInt(200, 800)} pages. If a student reads ${randomInt(20, 40)} pages per day, how many days to finish?`,
                    () => `A contract lasts ${randomInt(6, 24)} months. How many years is this?`,
                    () => `A fine is ¬£${randomInt(50, 500)}. If paid in ${randomInt(2, 10)} installments, how much per installment?`,
                    () => `A law exam has ${randomInt(50, 100)} questions. If a student answers ${randomInt(10, 20)} per hour, how many hours to finish?`,
                    () => `A legal secretary types ${randomInt(30, 60)} words per minute. How many words in ${randomInt(10, 30)} minutes?`,
                    () => `A law library has ${randomInt(1000, 5000)} books. If ${randomInt(10, 50)}% are on criminal law, how many is that?`,
                    () => `A lawyer bills ¬£${randomInt(50, 200)} per hour. How much for ${randomInt(5, 15)} hours?`,
                    () => `A legal team works ${randomInt(20, 40)} hours per week. How many hours in a year?`,
                    () => `A judge's gavel costs ¬£${randomInt(10, 50)}. If bought in sets of 5, cost per gavel?`,
                    () => `A law student reads ${randomInt(30, 80)} pages per day. How many in a month?`,
                    () => `A court fine is ¬£${randomInt(100, 1000)}. If paid in ${randomInt(2, 10)} installments, how much per installment?`,
                    () => `A law firm has ${randomInt(5, 20)} lawyers, each handling ${randomInt(10, 30)} cases. Total cases?`
                ]
            },
            health: {
                "gcse-foundation": [
                    () => `A nurse checks ${randomInt(4, 10)} patients per hour. How many can she see in an 8-hour shift?`,
                    () => `A patient takes ${randomInt(2, 4)} tablets per day. How many tablets are needed for a week?`,
                    () => `A hospital has ${randomInt(20, 40)} beds. If ${randomInt(5, 15)} are empty, how many are occupied?`,
                    () => `A doctor works ${randomInt(3, 5)} days a week. How many days does she work in a month (4 weeks)?`,
                    () => `A medicine costs ¬£${randomInt(2, 8)} per box. How much for ${randomInt(3, 6)} boxes?`,
                    () => `A patient needs to drink ${randomInt(1.5, 3)} litres of water daily. How many litres in a week?`,
                    () => `A thermometer shows a temperature of ${randomInt(36, 38)}¬∞C in the morning and ${randomInt(37, 39)}¬∞C in the evening. What is the increase?`,
                    () => `A bandage roll is ${randomInt(5, 10)} metres long. How many centimetres is that?`,
                    () => `A hospital orders ${randomInt(50, 200)} masks at ¬£${randomInt(0.5, 2)} each. What is the total cost?`,
                    () => `A patient walks ${randomInt(500, 1000)} metres daily. How many kilometres in a week?`,
                    () => `A first aid kit has ${randomInt(10, 20)} plasters. If ${randomInt(3, 8)} are used, how many remain?`,
                    () => `A nurse gives ${randomInt(1, 3)} injections per patient. How many injections for ${randomInt(5, 10)} patients?`,
                    () => `A patient‚Äôs weight drops from ${randomInt(70, 90)} kg to ${randomInt(65, 85)} kg. What is the weight loss?`,
                    () => `A doctor sees ${randomInt(10, 20)} patients a day. How many in a 5-day week?`,
                    () => `An ambulance travels ${randomInt(5, 15)} miles to an emergency. How many miles for ${randomInt(3, 6)} emergencies?`
                ],

                "gcse-higher": [
                    () => `A hospital has ${randomInt(4, 8)} wards with ${randomInt(10, 30)} patients each. What is the total patient count?`,
                    () => `A patient needs ${randomInt(50, 200)}mg of medicine daily for ${randomInt(7, 30)} days. What is the total dosage?`,
                    () => `A nurse administers medication to ${randomInt(5, 15)} patients per shift. If she works ${randomInt(3, 5)} shifts a week, how many patients does she treat?`,
                    () => `An IV drip delivers ${randomInt(20, 50)} ml per hour. How much fluid is given in ${randomInt(4, 12)} hours?`,
                    () => `A vaccine is ${randomInt(75, 95)}% effective in a trial of ${randomInt(1000, 5000)} people. How many were protected?`,
                    () => `A patient‚Äôs heart rate drops from ${randomInt(100, 120)} bpm to ${randomInt(60, 80)} bpm. What is the percentage decrease?`,
                    () => `A hospital orders ${randomInt(100, 500)} gloves at ¬£${randomInt(0.2, 1)} per pair. What is the total cost?`,
                    () => `A patient burns ${randomInt(150, 300)} calories per 30 minutes of exercise. How many calories in ${randomInt(1, 2.5)} hours?`,
                    () => `A doctor‚Äôs salary increases by ${randomInt(2, 10)}% from ¬£${randomInt(40000, 80000)}. What is the new salary?`,
                    () => `A patient takes ${randomInt(2, 5)} pills ${randomInt(2, 4)} times a day. How many pills per week?`,
                    () => `A blood donation is ${randomInt(450, 500)} ml. How many donations are needed to collect ${randomInt(2, 5)} litres?`,
                    () => `A hospital kitchen prepares ${randomInt(200, 500)} meals daily. How many in a 30-day month?`,
                    () => `A patient‚Äôs BMI drops from ${randomInt(30, 35)} to ${randomInt(25, 29)}. What is the decrease?`,
                    () => `An ambulance averages ${randomInt(40, 60)} mph over ${randomInt(10, 30)} miles. How many minutes does the journey take?`,
                    () => `A medical trial has a success rate of ${randomInt(60, 90)}% out of ${randomInt(200, 1000)} participants. How many were successful?`
                ],

                "btec": [
                    () => `A hospital has ${randomInt(5, 10)} wards, each with ${randomInt(15, 30)} beds. If ${randomInt(10, 20)}% are empty, how many patients are there?`,
                    () => `A patient requires ${randomInt(100, 300)} ml of fluid every ${randomInt(4, 8)} hours. What is the daily intake?`,
                    () => `A nurse earns ¬£${randomInt(12, 20)} per hour and works ${randomInt(30, 40)} hours a week. What is her monthly (4-week) pay?`,
                    () => `A medicine‚Äôs concentration is ${randomInt(5, 20)} mg per ml. How many mg in ${randomInt(10, 50)} ml?`,
                    () => `A hospital‚Äôs budget increases by ${randomInt(3, 8)}% from ¬£${randomInt(500000, 2000000)}. What is the new budget?`,
                    () => `A patient‚Äôs blood sugar level drops from ${randomInt(8, 12)} mmol/L to ${randomInt(4, 7)} mmol/L. What is the percentage decrease?`,
                    () => `A doctor sees ${randomInt(15, 30)} patients daily. If ${randomInt(10, 30)}% are follow-ups, how many are new patients?`,
                    () => `A clinical trial has a ${randomInt(70, 90)}% success rate with ${randomInt(200, 1000)} participants. How many saw no improvement?`,
                    () => `A hospital uses ${randomInt(1000, 5000)} gloves per month. If each box contains ${randomInt(50, 100)}, how many boxes are needed?`,
                    () => `A patient‚Äôs recovery time decreases from ${randomInt(14, 28)} days to ${randomInt(7, 13)} days. What is the percentage improvement?`
                ],

                "functional-skills": [
                    () => `A nurse checks ${randomInt(4, 8)} patients per hour. How many in a 6-hour shift?`,
                    () => `A patient takes ${randomInt(1, 3)} pills ${randomInt(2, 4)} times a day. How many pills per week?`,
                    () => `A hospital has ${randomInt(50, 100)} beds. If ${randomInt(10, 20)} are free, how many are occupied?`,
                    () => `A doctor works ${randomInt(4, 6)} hours a day. How many hours in a 5-day week?`,
                    () => `A box of bandages costs ¬£${randomInt(3, 8)}. How much for ${randomInt(2, 5)} boxes?`,
                    () => `A patient walks ${randomInt(200, 500)} metres daily. How many km in a week?`,
                    () => `A thermometer reading rises from ${randomInt(36, 37)}¬∞C to ${randomInt(38, 39)}¬∞C. What is the increase?`,
                    () => `A first aid kit has ${randomInt(10, 20)} bandages. If ${randomInt(3, 7)} are used, how many are left?`,
                    () => `A hospital orders ${randomInt(100, 300)} masks at ¬£${randomInt(0.5, 1.5)} each. What is the total cost?`,
                    () => `A patient drinks ${randomInt(1, 2.5)} litres of water daily. How many litres in a week?`
                ]
            }
        };
        

        let templates = [];
        if (contextualize && contextualTemplates[currentRoute] && contextualTemplates[currentRoute][difficulty]) {
            templates = contextualTemplates[currentRoute][difficulty];
        } else {
            templates = [
                () => `Solve for x: ${randomInt(2, 10)}x + ${randomInt(1, 20)} = ${randomInt(10, 50)}`,
                () => `Find the area of a rectangle with length ${randomInt(5, 20)} and width ${randomInt(3, 15)}`,
                () => `Calculate ${randomInt(2, 10)}^${randomInt(2, 5)}`,
                () => `What is ${randomInt(10, 100)}% of ${randomInt(50, 500)}?`
            ];
        }
        
        for (let i = 0; i < count; i++) {
            const template = templates[randomInt(0, templates.length - 1)];
            questions.push({
                question: template(),
                topic: topic || currentRoute || "General",
                difficulty: difficulty,
                style: style,
                route: currentRoute
            });
        }
        
        return questions;
    }

    function saveAIQuestions(questions, topic, difficulty, style) {
        questions.forEach(q => {
            mathRepository.userQuestions.push({
                question: q,
                topic: topic,
                difficulty: difficulty,
                style: style,
                route: currentRoute
            });
        });
    }


    document.getElementById('generate-questions').addEventListener('click', function() {
        let topic = document.getElementById('question-topic').value.trim();
        const difficulty = document.getElementById('generate-difficulty').value;
        const count = parseInt(document.getElementById('question-count').value);
        const style = document.getElementById('question-style').value;
        const contextualize = document.getElementById('contextualize-toggle').checked;

        // If topic is blank, use route or "General"
        if (!topic) topic = currentRoute || "General";

        document.getElementById('generate-processing').style.display = 'block';
        document.getElementById('generated-questions').style.display = 'none';

        setTimeout(() => {
            document.getElementById('generate-processing').style.display = 'none';

            // Generate questions based on parameters
            let questions = generateQuestions(topic, difficulty, count, style, contextualize);

            // Display generated questions
            let questionsHTML = '<ol>';
            questions.forEach((q, i) => {
                questionsHTML += `<li>${q.question} <span class="topic-tag">${q.difficulty}</span></li>`;
            });
            questionsHTML += '</ol>';

            document.getElementById('questions-output').innerHTML = questionsHTML;
            document.getElementById('generated-questions').style.display = 'block';
            MathJax.typesetPromise();

            // Save to AI questions
            saveAIQuestions(questions.map(q => q.question), topic, difficulty, style);
        }, 2000);
    });

    document.getElementById('add-to-quiz').addEventListener('click', function() {
        const questionsOutput = document.getElementById('questions-output');
        const questions = questionsOutput.querySelectorAll('li');
        
        if (questions.length === 0) {
        let topic = document.getElementById('question-topic').value.trim() || currentRoute || 'general';
        const difficulty = document.getElementById('generate-difficulty').value;
        questions.forEach(q => {
            mathRepository.userQuestions.push({
                question: q.textContent.replace(/ \w+$/, ''),
                topic: topic,
                difficulty: difficulty,
                route: currentRoute
            });
        });
        
        showToast(`${questions.length} questions saved to repository!`, 'success');
    });

    // --- Extra Buttons: Make all functional ---
    document.getElementById('generate-from-repo').addEventListener('click', function() {
        showToast('This would generate questions from repository topics.', 'info');
    });
    document.getElementById('regenerate-for-route').addEventListener('click', function() {
        document.getElementById('generate-questions').click();
    });
    document.getElementById('download-questions').addEventListener('click', function() {
        showToast('Download started (not implemented in demo).', 'info');
    });
    document.getElementById('export-repo').addEventListener('click', function() {
        showToast('Repository exported (not implemented in demo).', 'info');
    });
    document.getElementById('filter-repo').addEventListener('click', function() {
        showToast('Advanced filter coming soon!', 'info');
    });

    // --- PDF Import Tab Functionality (unchanged) ---
    document.getElementById('process-pdf').addEventListener('click', function() {
        const fileInput = document.getElementById('pdf-upload');
        if (!fileInput.files || fileInput.files.length === 0) {
            showToast('Please select a PDF file first.', 'error');
            return;
        }

        document.getElementById('pdf-processing').style.display = 'block';
        document.getElementById('pdf-preview').style.display = 'none';

        setTimeout(() => {
            document.getElementById('pdf-processing').style.display = 'none';

            const questionList = document.getElementById('question-list');
            questionList.innerHTML = '';

            for (let i = 0; i < 5; i++) {
                const questionItem = document.createElement('div');
                questionItem.className = 'question-item';
                questionItem.innerHTML = `
                    <input type="checkbox" class="question-checkbox" id="q${i}">
                    <label for="q${i}">Sample extracted question ${i+1} from PDF</label>
                `;
                questionList.appendChild(questionItem);
            }

            document.getElementById('pdf-preview').style.display = 'block';
            showToast('PDF processed successfully!', 'success');
        }, 2000);
    });

    document.getElementById('rewrite-questions').addEventListener('click', function() {
        document.getElementById('rewrite-options').style.display = 'block';
    });

    document.getElementById('apply-rewrite').addEventListener('click', function() {
        showToast('Questions rewritten with selected options', 'success');
        document.getElementById('rewrite-options').style.display = 'none';
    });

    document.getElementById('import-to-repository').addEventListener('click', function() {
        const checkedQuestions = document.querySelectorAll('#question-list .question-checkbox:checked');
        
        if (checkedQuestions.length === 0) {
            showToast('Please select questions to import.', 'error');
            return;
        }
        
        const topic = document.getElementById('curriculum-focus').value;
        
        checkedQuestions.forEach(q => {
            mathRepository.userQuestions.push({
                question: q.nextElementSibling.textContent,
                topic: topic,
                route: currentRoute
            });
        });
        
        showToast(`${checkedQuestions.length} questions imported to repository!`, 'success');
    });

    // --- Question Bank Tab Functionality (unchanged) ---
    document.getElementById('search-repo').addEventListener('click', function() {
        const searchTerm = document.getElementById('repo-search').value.trim();
        const filter = document.getElementById('repo-filter').value;
        
        document.getElementById('repo-processing').style.display = 'block';
        document.getElementById('repo-results').style.display = 'none';
        
        setTimeout(() => {
            document.getElementById('repo-processing').style.display = 'none';
            
            let filteredQuestions = [...mathRepository.questions, ...mathRepository.userQuestions];
            
            if (searchTerm) {
                filteredQuestions = filteredQuestions.filter(q => 
                    q.question.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    q.topic.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            if (filter !== 'all') {
                filteredQuestions = filteredQuestions.filter(q => q.route === filter);
            }
            
            const repoQuestions = document.getElementById('repo-questions');
            repoQuestions.innerHTML = '';
            
            if (filteredQuestions.length === 0) {
                repoQuestions.innerHTML = '<div class="text-center py-3">No questions found matching your criteria.</div>';
            } else {
                filteredQuestions.forEach((q, i) => {
                    const questionItem = document.createElement('div');
                    questionItem.className = 'question-item';
                    questionItem.innerHTML = `
                        <input type="checkbox" class="question-checkbox" id="repo-q${i}">
                        <label for="repo-q${i}">${q.question} 
                            <span class="topic-tag">${q.topic}</span>
                            <span class="topic-tag">${q.difficulty || 'general'}</span>
                        </label>
                    `;
                    repoQuestions.appendChild(questionItem);
                });
            }
            
            document.getElementById('repo-results').style.display = 'block';
        }, 1000);
    });

    document.getElementById('clear-search').addEventListener('click', function() {
        document.getElementById('repo-search').value = '';
        document.getElementById('repo-filter').value = 'all';
        document.getElementById('repo-results').style.display = 'none';
    });

    document.getElementById('create-quiz-from-repo').addEventListener('click', function() {
        const checkedQuestions = document.querySelectorAll('#repo-questions .question-checkbox:checked');
        
        if (checkedQuestions.length === 0) {
            showToast('Please select questions to add to quiz.', 'error');
            return;
        }
        
        checkedQuestions.forEach(q => {
            addQuestionToQuiz(q.nextElementSibling.textContent.replace(/ \w+ \w+$/, ''));
        });
        
        showToast(`${checkedQuestions.length} questions added to quiz!`, 'success');
    });

    document.getElementById('delete-repo-item').addEventListener('click', function() {
        const checkedQuestions = document.querySelectorAll('#repo-questions .question-checkbox:checked');
        
        if (checkedQuestions.length === 0) {
            showToast('Please select questions to delete.', 'error');
            return;
        }
        
        if (confirm(`Are you sure you want to delete ${checkedQuestions.length} question(s)?`)) {
            showToast(`${checkedQuestions.length} question(s) deleted.`, 'success');
            document.getElementById('search-repo').click();
        }
    });

    // --- Initialize the app ---
    document.addEventListener('DOMContentLoaded', function() {
        // Set badge color for initial route
        document.getElementById('route-badge').style.backgroundColor = 'var(--digital-color)';
        // Math keyboard focus
        document.getElementById('math-problem').addEventListener('focus', function() {
            showMathKeyboard(this);
        });
        // LaTeX toolbar insert buttons
        document.querySelectorAll('.latex-btn[data-insert]').forEach(btn => {
            btn.addEventListener('click', function() {
                const insert = this.getAttribute('data-insert');
                const textarea = document.getElementById('math-problem');
                if (!textarea) return;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                const before = text.substring(0, start);
                const after = text.substring(end, text.length);
                textarea.value = before + insert + after;
                textarea.focus();
                textarea.selectionStart = textarea.selectionEnd = start + insert.length;
            });
        });
    });
    </script>
</body>
</html>
